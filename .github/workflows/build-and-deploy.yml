name: Build and Deploy

on:
  push:
    branches: [ production ]
  workflow_dispatch: # Allow manual triggering

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, pdo, bcmath, zip
          coverage: none
          tools: composer:v2

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --optimize-autoloader --no-dev

      - name: Install NPM dependencies
        run: npm ci

      - name: Create environment file from secrets
        run: |
          cat > .env << 'EOF'
          APP_NAME="${{ secrets.APP_NAME || 'AMT CRM' }}"
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=${{ secrets.APP_URL || 'http://localhost' }}

          LOG_CHANNEL=stack
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=debug

          DB_CONNECTION=sqlite
          DB_DATABASE=':memory:'

          BROADCAST_DRIVER=log
          CACHE_DRIVER=file
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          EOF

      - name: Generate application key (if needed)
        run: |
          if [ -z "${{ secrets.APP_KEY }}" ]; then
            php artisan key:generate
          else
            echo "Using APP_KEY from secrets"
          fi

      - name: Run database migrations (local test)
        run: php artisan migrate --force
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: ':memory:'

      - name: Run tests
        run: |
          if [ -f "vendor/bin/phpunit" ]; then
            php artisan test --coverage --min=80
          else
            echo "PHPUnit not found, skipping tests"
          fi
        continue-on-error: false

      - name: Run PHPStan (Static Analysis)
        run: |
          if [ -f "vendor/bin/phpstan" ]; then
            vendor/bin/phpstan analyse app --level=5 --no-progress
          else
            echo "PHPStan not found, skipping static analysis"
          fi
        continue-on-error: true

      - name: Run PHP CS Fixer (Code Style)
        run: |
          if [ -f "vendor/bin/php-cs-fixer" ]; then
            vendor/bin/php-cs-fixer fix --dry-run --diff --verbose
          else
            echo "PHP CS Fixer not found, skipping code style check"
          fi
        continue-on-error: true

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: amt-crm-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create deployment package
        run: |
          tar -czf deployment.tar.gz \
            app/ \
            bootstrap/ \
            config/ \
            database/ \
            public/ \
            resources/ \
            routes/ \
            storage/ \
            docker/ \
            artisan \
            composer.json \
            composer.lock \
            Dockerfile \
            docker-compose.yml \
            package.json \
            package-lock.json \
            vite.config.js \
            docker-entrypoint.sh \
            .env.example

      - name: Copy deployment package to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER || 'root' }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          source: "deployment.tar.gz"
          target: "/srv/laravel-backend"
          overwrite: true
          timeout: 300s

      - name: Deploy on server (atomic, idempotent)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER || 'root' }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          timeout: 600s
          script: |
            set -e
            cd /srv/laravel-backend
            
            # Extract deployment package
            tar -xzf deployment.tar.gz
            
            # Create production .env file from secrets
            echo "ğŸ”§ Creating production environment file..."
            cat > .env << 'EOF'
            # Application Configuration
            APP_NAME="${{ secrets.APP_NAME || 'AMT CRM' }}"
            APP_ENV=production
            APP_KEY=${{ secrets.APP_KEY }}
            APP_DEBUG=false
            APP_URL=${{ secrets.APP_URL || 'https://api.himmanav.com' }}
            APP_LOCALE=en
            APP_FALLBACK_LOCALE=en
            APP_FAKER_LOCALE=en_US
            APP_MAINTENANCE_DRIVER=file

            # PHP Configuration
            PHP_CLI_SERVER_WORKERS=4
            BCRYPT_ROUNDS=12

            # Logging Configuration
            LOG_CHANNEL=stack
            LOG_STACK=single
            LOG_DEPRECATIONS_CHANNEL=null
            LOG_LEVEL=error

            # Database Configuration
            DB_CONNECTION=mysql
            DB_HOST=${{ secrets.DB_HOST || 'db' }}
            DB_PORT=${{ secrets.DB_PORT || '3306' }}
            DB_DATABASE=${{ secrets.DB_DATABASE || 'amt_crm_backend' }}
            DB_USERNAME=${{ secrets.DB_USERNAME || 'amt_crm_user' }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD || 'amt_crm_user_password_2024' }}
            DB_CHARSET=utf8mb4
            DB_COLLATION=utf8mb4_unicode_ci

            # Session Configuration
            SESSION_DRIVER=database
            SESSION_LIFETIME=120
            SESSION_ENCRYPT=false
            SESSION_PATH=/
            SESSION_SECURE_COOKIE=true
            SESSION_HTTP_ONLY=true
            SESSION_TABLE=sessions

            # Cache Configuration
            CACHE_STORE=database
            DB_CACHE_TABLE=cache

            # Queue Configuration
            QUEUE_CONNECTION=database
            DB_QUEUE_TABLE=jobs

            # Redis Configuration
            REDIS_CLIENT=phpredis
            REDIS_HOST=127.0.0.1
            REDIS_PORT=6379
            REDIS_DB=0

            # Broadcasting Configuration
            BROADCAST_DRIVER=log
            BROADCAST_CONNECTION=log

            # Filesystem Configuration
            FILESYSTEM_DISK=local

            # Mail Configuration
            MAIL_MAILER=${{ secrets.MAIL_MAILER || 'log' }}
            MAIL_SCHEME=null
            MAIL_HOST=${{ secrets.MAIL_HOST || '127.0.0.1' }}
            MAIL_PORT=${{ secrets.MAIL_PORT || '2525' }}
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS || 'no-reply@himmanav.com' }}
            MAIL_FROM_NAME="${{ secrets.MAIL_FROM_NAME || 'AMT CRM' }}"

            # AWS Configuration
            AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION || 'ap-south-1a' }}
            AWS_USE_PATH_STYLE_ENDPOINT=false

            # Vite Configuration
            VITE_APP_NAME="${{ secrets.APP_NAME || 'AMT CRM' }}"
            EOF

            # Backup current .env if it exists
            if [ -f ".env.backup" ]; then
              cp .env.backup .env.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # Create backup of new .env
            cp .env .env.backup

            # Check if db and nginx containers exist and are running
            DB_EXISTS=$(docker ps -a --format '{{.Names}}' | grep -c '^amt_crm_db$' || true)
            NGINX_EXISTS=$(docker ps -a --format '{{.Names}}' | grep -c '^amt_crm_nginx$' || true)

            # If first deploy (db/nginx not running), bring up all
            if [ "$DB_EXISTS" -eq 0 ] || [ "$NGINX_EXISTS" -eq 0 ]; then
              echo "ğŸš€ First deploy: starting all containers (db, nginx, app)"
              docker compose up --build -d
            else
              echo "ğŸ”„ Subsequent deploy: only updating app container"
              
              # Graceful shutdown of app container
              docker compose stop app || true
              docker rm -f amt_crm_app 2>/dev/null || true
              
              # Start new app container
              docker compose up --build -d app
            fi

            # Wait for containers to be ready
            echo "â³ Waiting for containers to be ready..."
            sleep 10
            
            # Check container status
            docker compose ps

            # Fix permissions for Laravel
            echo "ğŸ”§ Fixing Laravel permissions..."
            docker compose exec --user root app chown -R www:www /var/www/storage /var/www/bootstrap/cache || true
            docker compose exec --user root app chmod -R 775 /var/www/storage /var/www/bootstrap/cache || true

            # Run Laravel optimizations
            echo "âš¡ Running Laravel optimizations..."
            docker compose exec app php artisan config:cache || true
            docker compose exec app php artisan route:cache || true
            docker compose exec app php artisan view:cache || true
            
            # Run migrations if needed
            echo "ğŸ—„ï¸  Running database migrations..."
            docker compose exec app php artisan migrate --force || true

            # Wait for app to be fully ready
            echo "â³ Waiting for app to be ready..."
            sleep 30

            # Health check with retry logic
            echo "ğŸ¥ Performing health check..."
            for i in {1..5}; do
              if docker compose exec nginx curl -f -s http://localhost/health; then
                echo "âœ… Health check passed on attempt $i"
                break
              else
                echo "âŒ Health check failed on attempt $i"
                if [ $i -eq 5 ]; then
                  echo "ğŸš¨ Health check failed after 5 attempts. Checking logs..."
                  docker compose logs app --tail=50
                  docker compose logs nginx --tail=20
                  exit 1
                fi
                sleep 10
              fi
            done

            # Cleanup
            echo "ğŸ§¹ Cleaning up..."
            rm -f deployment.tar.gz
            
            # Remove old backups (keep last 5)
            ls -t .env.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -f
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application is available at: ${{ secrets.APP_URL || 'http://your-domain.com' }}"

      - name: Notify Deployment Success
        if: success()
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š Deployment Summary:"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Environment: Production"
          echo "- URL: ${{ secrets.APP_URL || 'http://your-domain.com' }}"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Check the logs above for details."
          echo "ğŸ“Š Failure Summary:"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Environment: Production" 